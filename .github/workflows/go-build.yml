name: Go-build

on:
  workflow_dispatch:
  release:
    types: [created]

jobs:
  releases-matrix:
    name: Release Go Binary
    runs-on: ubuntu-latest
    strategy:
      matrix:
        goos: [linux]
        goarch: ["386", amd64, arm64, mips, mipsle]

    env:
      CGO_ENABLED: 0          # static binary
      GOFLAGS: -trimpath      # optional, makes builds reproducible

    steps:
      # -------------------------------------------------
      # Checkout the **cloudflare/cloudflared** source
      # into the folder `src` (instead of cloning manually)
      # -------------------------------------------------
      - name: Checkout Cloudflare repo
        uses: actions/checkout@v3
        with:
          repository: cloudflare/cloudflared
          ref: main                 # or the tag/branch you need
          path: src                 # clone into ./src

      # -------------------------------------------------
      # Build & publish a fullyâ€‘static binary
      # -------------------------------------------------
      - name: Build & release static binary
        uses: wangyoucao577/go-release-action@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}

          goos: ${{ matrix.goos }}
          goarch: ${{ matrix.goarch }}
          goamd64: v1

          release_tag: latest
          release_name: "Release"

          project_path: "./src/cmd/cloudflared"
          binary_name:  "cloudflared"

          build_flags: "-a -trimpath"
          ldflags: "-s -w -linkmode external -extldflags '-static'"

          executable_compression: "upx --ultra-brute"
          overwrite: true

          asset_name: "cloudflared-latest-${{ matrix.goos }}-${{ matrix.goarch }}"
