# .github/workflows/go-build.yml
#
# Build static Go binaries for a matrix of platforms and publish them as a
# GitHub release.  The static linking works on Alpine Linux (musl) because
# CGO is disabled and the Go toolchain is told to link the C runtime statically.
#
# References:
#   • https://golang.org/wiki/Modules#releasing-modules
#   • https://github.com/wangyoucao577/go-release-action#readme
#   • https://github.com/actions/setup-go#installing-go

name: Go‑build

on:
  workflow_dispatch:               # manual trigger
  release:
    types: [created]               # run on tag creation, for example

jobs:
  releases-matrix:
    name: Release Go Binary
    runs-on: ubuntu-latest

    # ------------------------------------------------------------------
    # 1️⃣ Matrix – the OS/arch combos we want to build.
    # ------------------------------------------------------------------
    strategy:
      matrix:
        goos:   [linux]                     # only Linux for Alpine use‑case
        goarch: [386, amd64, arm64, mips, mipsle]

    # ------------------------------------------------------------------
    # 2️⃣ Global env for the whole job – disables cgo and forces static
    #     linking.  We also set GOFLAGS so that every `go build` gets the
    #     correct ldflags automatically (the release‑action also receives
    #     them, but having them here makes the job easier to debug locally).
    # ------------------------------------------------------------------
    env:
      CGO_ENABLED: 0                       # ❌ no cgo → pure‑Go static binary
      GOFLAGS: "-ldflags=-extldflags=-static"   # static C runtime
      GO111MODULE: on

    steps:
      # ---------------------------------------------------------------
      # 0️⃣ Checkout the repository (the action already does a shallow
      #     fetch, but we keep the explicit clone that you had before).
      # ---------------------------------------------------------------
      - uses: actions/checkout@v3

      # ---------------------------------------------------------------
      # 1️⃣ (Optional) Clean the workspace and re‑clone the upstream repo.
      #     You originally removed *everything* and then `git clone`
      #     Cloudflare’s repo.  This is preserved – it works fine.
      # ---------------------------------------------------------------
      - name: Refresh source tree
        run: |
          # Remove *everything* (including hidden files) – be careful!
          rm -rf ./{,.[!.],..?}*
          git clone https://github.com/cloudflare/cloudflared .

      # ---------------------------------------------------------------
      # 2️⃣ Install the Go toolchain (the release‑action will also install
      #     a version based on `go.mod`, but explicit installation makes
      #     the job self‑contained and gives us a chance to pin a version
      #     if you want.
      # ---------------------------------------------------------------
      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          # Using the latest stable; adjust if you need a specific version.
          go-version: 'stable'
          cache: true

      # ---------------------------------------------------------------
      # 3️⃣ Install UPX (optional – used for binary compression).
      # ---------------------------------------------------------------
      - name: Install UPX
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y upx

      # ---------------------------------------------------------------
      # 4️⃣ Build & publish the static binary.
      # ---------------------------------------------------------------
      - name: Build & Release
        uses: wangyoucao577/go-release-action@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}

          goos:           ${{ matrix.goos }}
          goarch:         ${{ matrix.goarch }}
          goamd64:        v1                # only relevant for amd64

          # Path inside the repo where the `main` package lives.
          project_path:   "./cmd/cloudflared"

          # Desired binary name (without .exe on Windows – the action adds it if needed)
          binary_name:    "cloudflared"

          # Overwrite any existing asset with the same name.
          overwrite:      true

          # Release/tag settings – you had `latest`; keep it.
          release_tag:    latest
          release_name:   "Release"
          asset_name:     "cloudflared-latest-${{ matrix.goos }}-${{ matrix.goarch }}"

          # Build flags:
          #   -a            → force rebuilding of packages
          #   -ldflags ...  → strip debug info & force static linking (handled by GOFLAGS)
          #   -trimpath     → remove absolute file system paths from the binary (optional, makes reproducible builds)
          build_flags:    "-a -trimpath"

          # Linker flags (kept for strip, but static linking already set via GOFLAGS)
          ldflags:        "-w -s"

          # Optional compression with UPX (kept from your original config)
          executable_compression: "upx --ultra-brute"
