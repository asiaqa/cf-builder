# ------------------------------------------------------------
# Build static cloudflared binaries for Linux/386, amd64,
# arm64, mips and mipsle, then publish them as a GitHub release.
#
# The key change: a single ldflags value that includes
#   -w -s               (size optimisation)
#   -extldflags=-static (force static linking)
# ------------------------------------------------------------
name: Go‑build

on:
  workflow_dispatch:      # manual trigger
  release:
    types: [created]      # fire when a tag/release is created

jobs:
  releases-matrix:
    name: Release Go Binary
    runs-on: ubuntu-latest

    strategy:
      matrix:
        goos:   [linux]                # only Linux (Alpine)
        goarch: [386, amd64, arm64, mips, mipsle]

    # --------------------------------------------------------
    # Environment – disable cgo, no extra GOFLAGS needed.
    # --------------------------------------------------------
    env:
      CGO_ENABLED: 0                  # pure‑Go → static binary
      GO111MODULE: on

    steps:
      # ----------------------------------------------------
      # 0️⃣ Checkout the repo (the original workflow also
      #    re‑cloned the upstream project – we keep that.
      # ----------------------------------------------------
      - uses: actions/checkout@v3

      - name: Refresh source tree (clone upstream)
        run: |
          rm -rf ./{,.[!.],..?}*
          git clone https://github.com/cloudflare/cloudflared .

      # ----------------------------------------------------
      # 1️⃣ Install Go (latest stable; pin if you prefer)
      # ----------------------------------------------------
      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: 'stable'   # or a concrete version, e.g. 1.22.5
          cache: true

      # ----------------------------------------------------
      # 2️⃣ Ensure UPX is present for optional compression
      # ----------------------------------------------------
      - name: Install UPX
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y upx

      # ----------------------------------------------------
      # 3️⃣ Build & publish the static binary
      # ----------------------------------------------------
      - name: Build & Release
        uses: wangyoucao577/go-release-action@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}

          goos:           ${{ matrix.goos }}
          goarch:         ${{ matrix.goarch }}
          goamd64:        v1            # only relevant for amd64

          project_path:   "./cmd/cloudflared"
          binary_name:    "cloudflared"

          # Force static linking + strip debug symbols in ONE ldflags string
          ldflags:        "-w -s -extldflags=-static"

          # Keep the original options you liked
          build_flags:    "-a -trimpath"
          executable_compression: "upx --ultra-brute"
          overwrite:      true
          release_tag:    latest
          release_name:   "Release"
          asset_name:     "cloudflared-latest-${{ matrix.goos }}-${{ matrix.goarch }}"
